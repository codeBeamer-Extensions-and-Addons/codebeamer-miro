!function(e){var t={};function i(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(n,o,function(t){return e[t]}.bind(null,o));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=6)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(){this.state={appId:"",LS_KEY:"codebeamer-miro-plugin-widget-private-settings",NEWPOS:"NEWPOS",onReadyCalled:!1,onReadyFuncs:[]}}static getInstance(){return n.instance||(n.instance=new n),n.instance}static setAppId(){n.getInstance().state.appId=miro.getClientId()}}t.default=n},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{s(n.next(e))}catch(e){r(e)}}function d(e){try{s(n.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,d)}s((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.deleteWidget=t.createOrUpdateWidget=t.findLinesByFromCard=t.findWidgetByTypeAndMetadataId=t.getWidgetDetail=void 0;const o=i(0).default.getInstance();function r(e){return n(this,void 0,void 0,(function*(){return(yield miro.board.widgets.get({type:e.type})).filter(e=>!!e.metadata[o.state.appId]).find(t=>t.metadata[o.state.appId].id===e.metadata[o.state.appId].id)}))}t.getWidgetDetail=function(e){return n(this,void 0,void 0,(function*(){return(yield miro.board.widgets.get(e))[0]}))},t.findWidgetByTypeAndMetadataId=r,t.findLinesByFromCard=function(e){return n(this,void 0,void 0,(function*(){return(yield miro.board.widgets.get({type:"LINE"})).filter(t=>t.metadata[o.state.appId]&&t.startWidgetId===e)}))},t.createOrUpdateWidget=function(e){return n(this,void 0,void 0,(function*(){const t=yield r(e);return t?(e.id=t.id,yield function(e){return n(this,void 0,void 0,(function*(){let t=(yield miro.board.widgets.update(e))[0],i=t.metadata[o.state.appId].id;return console.log(`${t.type} widget ${t.id} has been updated to match item ${i||"<the settings>"}`),t}))}(e)):yield function(e){return n(this,void 0,void 0,(function*(){if(!("CARD"!==e.type||e.x&&e.y)){const t=yield miro.board.viewport.get();e.x=t.x+t.width/2,e.y=t.y+t.height/2}let t=(yield miro.board.widgets.create(e))[0],i=t.metadata[o.state.appId].id;return console.log(`${t.type} widget ${t.id} has been created to match item ${i||"<the settings>"}`),t}))}(e)}))},t.deleteWidget=function(e){return n(this,void 0,void 0,(function*(){return yield miro.board.widgets.deleteById(e)}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{s(n.next(e))}catch(e){r(e)}}function d(e){try{s(n.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,d)}s((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.submitNewCodeBeamerItem=t.createOrUpdateCbItem=t.getCodeBeamerAssociationDetails=t.getCodeBeamerOutgoingAssociations=t.getCodeBeamerItems=t.getCodeBeamerItemURL=void 0;const o=i(0),r=i(1),a=i(3),d=i(4),s=o.default.getInstance();function c(){return n(this,void 0,void 0,(function*(){let e=new Headers({"Content-Type":"application/json"}),t=yield d.getPrivateSetting("cbUsername"),i=yield d.getPrivateSetting("cbPassword");return e.append("Authorization","Basic "+btoa(t+":"+i)),e}))}function l(){return n(this,void 0,void 0,(function*(){return new URL(yield d.getBoardSetting("cbAddress"))}))}function u(){return n(this,void 0,void 0,(function*(){let e=yield l();return e.pathname=e.pathname+"/api/v3",e}))}function f(e){return n(this,void 0,void 0,(function*(){return e.tracker=yield function(e){return n(this,void 0,void 0,(function*(){return yield fetch(`${yield u()}/trackers/${e.id}`,{method:"GET",headers:yield c()}).then(e=>e.json())}))}(e.tracker),e.renderedDescription="Wiki"===e.descriptionFormat?yield function(e,t){return n(this,void 0,void 0,(function*(){let i={contextId:t.id,contextVersion:t.version,renderingContextType:"TRACKER_ITEM",markup:e};return yield fetch(`${yield u()}/projects/${t.tracker.project.id}/wiki2html`,{method:"POST",headers:yield c(),body:JSON.stringify(i)}).then(e=>e.text())}))}(e.description,e):e.description,e}))}function g(e){return n(this,void 0,void 0,(function*(){yield f(e);let t=yield a.convert2Card(e);return e.card=yield r.createOrUpdateWidget(t),e}))}t.getCodeBeamerItemURL=function(e){return n(this,void 0,void 0,(function*(){let t=yield l();return t.pathname=t.pathname+"/issue/"+e,t}))},t.getCodeBeamerItems=function(){return n(this,void 0,void 0,(function*(){try{let e=yield u();e.pathname=e.pathname+"/items/query",e.search="page=1&pageSize=500&queryString="+(yield d.getBoardSetting("cbqlQuery"));return(yield fetch(e.toString(),{method:"GET",headers:yield c()}).then(e=>e.json())).items}catch(e){console.log("Error while getting items from codeBeamer",e)}}))},t.getCodeBeamerOutgoingAssociations=function(e){return n(this,void 0,void 0,(function*(){return(yield fetch(`${yield u()}/items/${e.id}/relations`,{method:"GET",headers:yield c()}).then(e=>e.json())).outgoingAssociations}))},t.getCodeBeamerAssociationDetails=function(e){return n(this,void 0,void 0,(function*(){return yield fetch(`${yield u()}/associations/${e.id}`,{method:"GET",headers:yield c()}).then(e=>e.json())}))},t.createOrUpdateCbItem=g,t.submitNewCodeBeamerItem=function(e){return n(this,void 0,void 0,(function*(){e=yield r.getWidgetDetail({id:e.id});let t=a.convert2CbItem(e),i=yield function(e){return n(this,void 0,void 0,(function*(){return yield fetch(`${yield u()}/trackers/${yield d.getBoardSetting("inboxTrackerId")}/items`,{method:"POST",headers:yield c(),body:JSON.stringify(e)}).then(e=>e.json())}))}(t);i[s.state.NEWPOS]={x:e.x,y:e.y},r.deleteWidget(e),yield g(i),miro.board.selection.selectWidgets({id:i.card.id})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{s(n.next(e))}catch(e){r(e)}}function d(e){try{s(n.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,d)}s((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.convert2CbItem=t.convert2Line=t.convert2Card=void 0;const o=i(0),r=i(2),a=o.default.getInstance();function d(e){let t={lineType:miro.enums.lineType.ARROW,lineStyle:miro.enums.lineStyle.NORMAL,lineEndStyle:miro.enums.lineArrowheadStyle.ARC_ARROW,lineStartStyle:miro.enums.lineArrowheadStyle.NONE,lineThickness:1};switch(e.type.id){case 1:t.lineColor="#cf7f30",t.lineEndStyle=6,t.lineThickness=5;break;case 4:case 9:t.lineColor="#21cfb7",t.lineStyle=1,t.lineStartStyle=1;break;case 6:case 8:case 7:t.lineColor="#b32525"}return t}t.convert2Card=function(e){return n(this,void 0,void 0,(function*(){let t={type:"CARD",title:`<a href="${yield r.getCodeBeamerItemURL(e.id)}">[${e.tracker.keyName}-${e.id}] - ${e.name}</a>`,description:e.renderedDescription,card:{logo:{iconUrl:window.location.href+"img/codeBeamer-Logo-BW.png"},customFields:[{mainColor:"#4f8ae8",fontColor:"#ffffff",value:"Status: "+e.status.name},{value:"Release: "+(e.release?e.release.name:"--")}]},capabilities:{editable:!1},metadata:{[a.state.appId]:{id:e.id}}},i=function(e){var t=e.customFields?e.customFields.find(e=>"ColorFieldValue"===e.type):null;return t?t.value:null}(e),n=i||(e.tracker.color?e.tracker.color:null);return n&&(t.style={backgroundColor:n}),e[a.state.NEWPOS]&&(t.x=e[a.state.NEWPOS].x,t.y=e[a.state.NEWPOS].y),t}))},t.convert2Line=function(e,t,i){return{type:"LINE",startWidgetId:t,endWidgetId:i,style:d(e),capabilities:{editable:!1},metadata:{[a.state.appId]:{id:e.id}}}},t.convert2CbItem=function(e){let t={name:"New Item",description:"--"};switch(e.type){case"CARD":const n=(i=e.title,(new DOMParser).parseFromString(i,"text/html").body.textContent);n&&(t.name=n),e.description&&(t.description=e.description);break;case"SHAPE":case"STICKER":e.plainText&&(t.name=e.plainText);break;case"TEXT":e.text&&(t.name=e.text);break;default:throw`Widget type '${e.type}' not supported`}var i;return t}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{s(n.next(e))}catch(e){r(e)}}function d(e){try{s(n.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,d)}s((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getPrivateSetting=t.savePrivateSettings=t.saveBoardSettings=t.getBoardSetting=t.findSettingsWidget=t.isSelectionConvertable=t.createOrHideSettingsWidget=void 0;const o=i(0),r=i(1),a=o.default.getInstance();function d(){return n(this,void 0,void 0,(function*(){return(yield miro.board.widgets.get({type:"SHAPE"})).filter(e=>!!e.metadata[a.state.appId]).find(e=>!!e.metadata[a.state.appId].settings)}))}t.createOrHideSettingsWidget=function(){return n(this,void 0,void 0,(function*(){let e=yield d();return e?(e.clientVisible=!1,yield r.createOrUpdateWidget(e)):e=yield r.createOrUpdateWidget({type:"SHAPE",text:"codeBeamer-miro Settings. You should not be able to see this!",clientVisible:!1,metadata:{[a.state.appId]:{settings:{}}}}),e}))},t.isSelectionConvertable=function(e){return 1===e.length&&((!(t=e[0]).metadata||!t.metadata[a.state.appId])&&["STICKER","CARD","TEXT","SHAPE"].includes(t.type));var t},t.findSettingsWidget=d,t.getBoardSetting=function(e){return n(this,void 0,void 0,(function*(){const t=yield d();if(t)return t.metadata[a.state.appId].settings[e]}))},t.saveBoardSettings=function(e){return n(this,void 0,void 0,(function*(){const t=yield d();return t&&Object.assign(t.metadata[a.state.appId].settings,e),yield r.createOrUpdateWidget(t)}))},t.savePrivateSettings=function(e){return n(this,void 0,void 0,(function*(){const t=localStorage.getItem(a.state.LS_KEY);let i=null===t?{}:JSON.parse(t);Object.assign(i,e),localStorage.setItem(a.state.LS_KEY,JSON.stringify(i))}))},t.getPrivateSetting=function(e){return n(this,void 0,void 0,(function*(){return JSON.parse(localStorage.getItem(a.state.LS_KEY)||"{}")[e]}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{s(n.next(e))}catch(e){r(e)}}function d(e){try{s(n.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,d)}s((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.syncWithCodeBeamer=t.onAllWidgetsLoaded=t.onReady=void 0;const o=i(0),r=i(3),a=i(1),d=i(2),s=o.default.getInstance();function c(e){return n(this,void 0,void 0,(function*(){let t=yield d.getCodeBeamerOutgoingAssociations(e);const i=yield a.findLinesByFromCard(e.card.id);let o=Promise.all(i.map(e=>n(this,void 0,void 0,(function*(){t.find(t=>e.metadata[s.state.appId].id===t.id)||(console.log(`deleting line ${e.id} because the association ${e.metadata[s.state.appId].id} does not exist anymore`),yield a.deleteWidget(e))})))),c=Promise.all(t.map(t=>n(this,void 0,void 0,(function*(){const i=yield a.findWidgetByTypeAndMetadataId({type:"CARD",metadata:{[s.state.appId]:{id:t.itemRevision.id}}});if(console.log(`Association ${t.id}: card for codeBeamer ID ${t.itemRevision.id} is: ${i?i.id:"NOT FOUND (item not synced)"}`),i){let n=yield d.getCodeBeamerAssociationDetails(t);yield a.createOrUpdateWidget(r.convert2Line(n,e.card.id,i.id))}}))));yield Promise.all([o,c])}))}miro.onReady(()=>{for(s.state.appId=miro.getClientId(),s.state.onReadyCalled=!0;s.state.onReadyFuncs.length;)s.state.onReadyFuncs.shift().call()}),t.onReady=function(e){s.state.onReadyCalled?e():s.state.onReadyFuncs.push(e)},t.onAllWidgetsLoaded=function(e){return n(this,void 0,void 0,(function*(){(yield miro.board.widgets.areAllWidgetsLoaded())?e():miro.addListener("ALL_WIDGETS_LOADED",e)}))},t.syncWithCodeBeamer=function(){return n(this,void 0,void 0,(function*(){yield d.getCodeBeamerItems().then(e=>n(this,void 0,void 0,(function*(){console.log("starting createOrUpdateCbItem for all Items");for(let t=0;t<e.length;t++)yield d.createOrUpdateCbItem(e[t]);console.log("starting createUpdateOrDeleteAssociationLines for all Items");for(let t=0;t<e.length;t++)yield c(e[t])}))),miro.showNotification("Sync with codeBeamer finished!")}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{s(n.next(e))}catch(e){r(e)}}function d(e){try{s(n.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,d)}s((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=i(0),r=i(5),a=i(4),d=i(2),s='<svg enable-background="new 0 0 256 256" version="1.1" viewBox="0 0 256 256" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" height="24" width="24" fill="#050038"><path class="st0" d="M128,255c70.1,0,127-56.9,127-127S198.1,1,128,1S1,57.9,1,128S57.9,255,128,255"/><path class="st1" d="m142.7 103.9c1.4 12.6 2.6 29.3 21.5 18.5 0.5-0.2 0.9-0.5 1.2-0.7 4.5-6.7-0.2-20.9 5.1-20 5.9 1-1.2 7.6 1.8 12.7 3.1-2.1 3.6-11 7.9-8.3 4.2 2.6-3.4 5.6-3.7 8.9 2.7 1.4 10.4-6 11.4-0.7 0.9 4-9.3 3.4-10.3 5.4 2.1 3.3 12.7 0.7 10.1 6-2.2 4.4-9.4-3.3-13.6-2 1.2 3.7 8.9 4.4 5.7 8-2.9 3.3-6.8-2.5-11.7-7.1-0.6 0.7-1.2 1.4-1.9 2.1-11.9 11.9-26 8.9-33.2-3.5-3.5-6-3.3-9.7-4.3-16.2-1.3 4-2.2 7.8-2.6 11.6-10.5 9.2-19.8 19.1-22.8 34.2 7-5.5 13.6-13.1 20.4-9.8 6.4 3.1 11.4 12.6 13.6 20.2 6.1-2.8 11.2-5.8 12.8-1.6 1.9 5.3-6.8 2.8-9.6 6.4 4 3.1 15.1-2.4 15.7 3.3 0.7 6.9-9.9-0.4-13.6 2.4 0.3 2.6 11.6 6.1 9.1 10.1-3.4 5.3-8.9-5.9-12.3-5.6-1.1 3.8 5.9 10.1 0.3 11.3-5.9 1.2-2.7-8.7-5.2-12.3-5.4 4.2-0.3 14.4-7.2 13.1-6-1.2 4-13.8 2.9-23-2.8-3.3-5.9-6.5-8.9-5.4-6.3 2.5-6.7 9.3-17.9 13.6 8.8 17 33.4 33.9 57.1 32.4 21.4-1.4 46-18.3 36.6-55.5-1.2-4.7-1-6.5 2.1-0.7 14.2 26.8-4.8 72.1-54.3 66.8-58.6-6.2-63.2-56.8-81.2-61.2-4-1-8.1 3.1-11.7 6.2 0.4 8.3 5.1 17.8-0.4 18.4-5.2 0.6-1-6.8-3.7-10.1-3.7 2.9-1.1 14.3-6.5 13.5-6.4-0.9 2.6-8.9 0.8-12.8-2.5-0.3-8.1 9.2-11.2 6-4.2-4.3 7.3-6.7 7.7-9.9-3.2-1.8-10.6 3.2-10.4-2.2 0.2-5.5 8.5-0.5 12.4-2-2.7-5.9-13.1-3.5-10.4-9.5 1.8-3.9 7.4 1.8 13.8 5.3 2-8.1 11.3-21.4 18-21.9 5.4-0.4 9.9 4.1 14.4 8.9-0.2-2.6-0.2-5.2-0.1-7.9 0.5-24.5 9.5-46.2 44.9-61.1 1.4-10.4-9.9-13.4-8-20.8 1.6-5.7 9.5-10.9 16.3-12.7-2.9-5.5-6.5-10.2-2.8-11.9 4.4-2 2.8 5.7 6.1 7.8 2.4-3.6-3-12.7 1.9-13.6 5.8-1 0.2 8.4 2.9 11.4 2.2-0.4 4.4-10.3 8-8.4 4.8 2.6-4.5 7.9-3.9 10.8 3.3 0.7 8.2-5.7 9.6-1 1.4 4.9-7.3 2.8-10.2 5.2 3.9 4.4 12.3-0.5 11.6 5.4-0.6 4.9-10.8-1.8-18.5-1.2-3.3 2.5-7.2 6.1-7 9.4 0.3 5 6.7 9 10.6 13.4 7.4-3.2 6.6-10.9 12-13.8 20-11 51.4 6.3 51.6 14.9 0.1 8.2-17.3 19.7-32.1 23.2-3.5 0.8-6.1-0.5-8.4-1.8-8.8-5.3-11.7 3.1-18.3 9.4" fill="#FFFFFF"/></svg>';miro.onReady(()=>{o.default.setAppId(),miro.initialize({extensionPoints:{bottomBar:{title:"CodeBeamer Sync",svgIcon:s,onClick:r.syncWithCodeBeamer},toolbar:{title:"codeBeamer<->Miro Settings",librarySvgIcon:s,toolbarSvgIcon:s,onClick:()=>n(void 0,void 0,void 0,(function*(){let e=yield miro.board.ui.openModal("settings.html");console.log(JSON.stringify(e))}))},getWidgetMenuItems:function(e){var t=[];return a.isSelectionConvertable(e)&&t.push({tooltip:"Convert to codeBeamer Item",svgIcon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 20C16 19.4477 16.4477 19 17 19H20V4H4V19H7C7.55228 19 8 19.4477 8 20C8 20.5523 7.55228 21 7 21H3C2.44772 21 2 20.5523 2 20V3C2 2.44772 2.44772 2 3 2H21C21.5523 2 22 2.44771 22 3V20C22 20.5523 21.5523 21 21 21H17C16.4477 21 16 20.5523 16 20Z" fill="#050038"/><path d="M11 21.5V11.9142L9.41421 13.5C9.02369 13.8905 8.39052 13.8905 8 13.5C7.60948 13.1095 7.60948 12.4763 8 12.0858L12 8.08579L16 12.0858C16.3905 12.4763 16.3905 13.1095 16 13.5C15.6095 13.8905 14.9763 13.8905 14.5858 13.5L13 11.9142V21.5C13 22.0523 12.5523 22.5 12 22.5C11.4477 22.5 11 22.0523 11 21.5Z" fill="#050038"/></svg>',onClick:()=>d.submitNewCodeBeamerItem(e[0])}),Promise.resolve(t)}}}),r.onAllWidgetsLoaded(()=>n(void 0,void 0,void 0,(function*(){let e=yield a.createOrHideSettingsWidget();console.log("codebeamer-miro settings are now hidden: "+e.id)})))})}]);