import"./regular-expressions.11563385.js";import{u as Y,a as q,r,a2 as ae,x as a,a3 as se,a4 as re,a5 as ie,a6 as ne,D as oe,a7 as le,S as M,Z as ce,_ as de,$ as me,a0 as ue,Y as fe,E as ge,a1 as Ee}from"./BoardSettingsLoader.e463b184.js";function W(s,t="item"){return t.includes("Reference")&&(t=t.split("Reference")[0]),t.includes("Tracker")&&(t=t.split("Tracker")[1]),`/${t.toLowerCase()}/${s}`}function P(s){let t=s.split("/");return t[t.length-1]}function D(s){var t;if(!s.id&&!s.uri)throw new Error("Data must have either id or uri!");return{uri:(t=s.uri)!=null?t:W(s.id,s.type),name:s.name}}const he="assignedTo",E="assignedTo",be="team",p="teams",ye="storyPoints",v="storyPoints",pe="versions",I="versions",Ie="realizedFeature",k="subjects",ke=[{label:"Assignee",name:E,legacyName:he,type:"array"},{label:"Team",name:p,legacyName:be,type:"array"},{label:"Story Points",name:v,legacyName:ye,type:"number"},{label:"Version",name:I,legacyName:pe,type:"array"},{label:"Subject",name:k,legacyName:Ie,type:"array"}];const U=/href\=\"\/cb/g,Se=/src\=\"\/cb/g;function Ne(s,t){return console.log(t.match(U)),t=t.replaceAll(U,`href="${s}`),t=t.replaceAll(Se,`src="${s}`),t=t.replaceAll(/\<a /g,'<a target="_blank" '),t}function ve(s){var S;Y();const{cbAddress:t}=q(y=>y.boardSettings),[h,d]=r.exports.useState((S=s.item.description)!=null?S:""),[b,l]=ae();a.useEffect(()=>{!s.item.id||!s.item.description||b({itemId:s.item.id,markup:s.item.description})},[s.item.description]),a.useEffect(()=>{l.error&&console.warn("Failed to convert wiki description to html"),l.data&&d(t?Ne(t,l.data):l.data)},[l]);const x=async()=>{if(!s.cardId){miro.board.notifications.showError("Can't zoom to the Item, since its card Id is unknown");return}let y=await miro.board.getById(s.cardId);y||miro.board.notifications.showError("Can't zoom to the Item, since it doesn't exist on the board"),miro.board.viewport.zoomTo(y)};return a.createElement(a.Fragment,null,a.createElement("div",{className:"title sticky"},a.createElement("h3",{className:"h3","data-test":"summary-summary"},s.item.name,s.item.id&&a.createElement("small",null," #",s.item.id," "),s.cardId&&a.createElement("span",{className:"icon icon-eye clickable pos-adjusted-down",title:"Click to zoom to the item",onClick:()=>x(),"data-test":"summary-zoom-to-item"}))),h&&a.createElement("p",{"data-test":"summary-description",className:"overflow-ellipsis",dangerouslySetInnerHTML:{__html:h}}))}function Fe(s){var Q,G,j,B,H;const[t,h]=r.exports.useState(),[d,b]=r.exports.useState([]),[l,x]=r.exports.useState(),[S,y]=r.exports.useState(!0),[T,w]=r.exports.useState(!1),[_,z]=r.exports.useState(""),[F,J]=r.exports.useState([]),V=xe(d),{cbAddress:Z}=q(e=>e.boardSettings),[$,N]=se(),[K,n]=re(),[X,u]=ie(),[ee,L]=ne();a.useEffect(()=>{$(s.itemId)},[]),a.useEffect(()=>{if(n.error){console.error("Fatal error - couldn't load tracker schema: ",n.error),z("Failed loading tracker schema");return}else n.data&&(b(n.data),A(E),y(!1))},[n]),a.useEffect(()=>{N.error?(console.error("Fatal error - couldn't load Item data",N.error),z(`Failed loading Item data from ${Z} for Item with Id ${s.itemId}`)):N.data&&(h(N.data),x(N.data.tracker.id.toString()),(!d||!d.length)&&!n.isFetching&&K(N.data.tracker.id),oe(N.data,s.cardId))},[N]),a.useEffect(()=>{L.error||L.data&&($(s.itemId),w(!0),setTimeout(()=>{w(!1)},2e3))},[L]);const A=e=>{var c,g;if(F.find(m=>m.key==e)||((c=V.find(m=>m.key==e))==null?void 0:c.value)||!n.data||!l)return;const o=(g=n.data.find(m=>m.trackerItemField==e))==null?void 0:g.id;if(!o){const m=`Can't find field for ${e} in Tracker schema - therefore can't load options.`;console.warn(m),miro.board.notifications.showError(m);return}X({trackerId:l,fieldId:o})};a.useEffect(()=>{u.error&&(console.error(u.error),miro.board.notifications.showError("Failed loading options"))},[u.error]),a.useEffect(()=>{var e,o,c;if(u.data){const g=(e=u.originalArgs)==null?void 0:e.fieldId;if(!g)console.warn("Can't determine which field the received data are options for.");else{const m=(c=(o=n.data)==null?void 0:o.find(O=>O.id==g))==null?void 0:c.trackerItemField;if(!m){console.warn("Can't determine which field the received data are options for.");return}const te=[...F.filter(O=>O.key!==m),{key:m,values:u.data}];J(te)}}},[u.data]);const C=e=>{var c;if(!n.data)return e;let o=(c=n.data.find(g=>g.legacyRestName==e||g.trackerItemField==e))==null?void 0:c.name;return o!=null?o:e},f=e=>{var o,c;return(c=(o=V.find(g=>g.key==e))==null?void 0:o.value)!=null?c:!1},R=e=>{var o;return((o=d.find(c=>c.trackerItemField==e))==null?void 0:o.multipleValues)||!1},i=le({initialValues:{assignedTo:t!=null&&t.assignedTo?t.assignedTo:[],teams:t!=null&&t.teams?t.teams:[],storyPoints:(Q=t==null?void 0:t.storyPoints)!=null?Q:-1,versions:t!=null&&t.versions?t.versions:[],subjects:t!=null&&t.subjects?t.subjects:[]},enableReinitialize:!0,validate:e=>({}),onSubmit:e=>{console.log("Submitting");const o={uri:W(t.id),assignedTo:e.assignedTo.map(D),team:e.teams.map(D),versions:e.versions.map(D),realizedFeature:e.subjects.map(D),storyPoints:e.storyPoints};ee(o)}});return a.createElement(a.Fragment,null,_&&a.createElement("div",{className:"centered","data-test":"fatal-error"},a.createElement("h3",{className:"h3"},"Fatal error"),a.createElement("p",null,_)),!_&&S&&a.createElement("div",{className:"centered loading-spinner-lg"}),!_&&!S&&t&&a.createElement("div",{className:"fade-in centered-horizontally h-100 flex-col w-85"},a.createElement("div",{className:"panel-header h-max-25"},a.createElement(ve,{item:t,cardId:s.cardId})),a.createElement("hr",null),a.createElement("div",{className:"panel-content mt-1 h-75 overflow-auto"},a.createElement("form",{onSubmit:i.handleSubmit,className:"flex-col position-relative h-100"},a.createElement("h6",{className:"h6 pb-3"},"Editable attributes:"),a.createElement("div",{hidden:!n.data||f(E),className:`form-group fade-in-quick${i.touched.assignedTo?i.errors.assignedTo?"error":"success":""}`,onClick:()=>A(E)},a.createElement("label",{"data-test":E},C(E)),a.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((G=F.find(e=>e.key==E))==null?void 0:G.values)||[],value:i.values.assignedTo,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:u.isFetching,isMulti:R(E),isSearchable:!0,isClearable:!0,isDisabled:!n.data||f(E),onChange:e=>i.setFieldValue(E,e),maxMenuHeight:180})),a.createElement("div",{hidden:!n.data||f(p),className:`form-group fade-in-quick${i.touched.teams?i.errors.teams?"error":"success":""}`,onClick:()=>A(p)},a.createElement("label",{"data-test":p},C(p)),a.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((j=F.find(e=>e.key==p))==null?void 0:j.values)||[],value:i.values.teams,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:u.isFetching,isMulti:R(p),isSearchable:!0,isClearable:!0,isDisabled:!n.data||f(p),onChange:e=>i.setFieldValue(p,e),maxMenuHeight:180})),a.createElement("div",{hidden:!n.data||f(I),className:`form-group fade-in-quick${i.touched.versions?i.errors.versions?"error":"success":""}`,onClick:()=>A(I)},a.createElement("label",{"data-test":I},C(I)),a.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((B=F.find(e=>e.key==I))==null?void 0:B.values)||[],value:i.values.versions,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:u.isFetching,isMulti:R(I),isSearchable:!0,isClearable:!0,isDisabled:!n.data||f(I),onChange:e=>i.setFieldValue(I,e),maxMenuHeight:180})),a.createElement("div",{hidden:!n.data||f(k),className:`form-group fade-in-quick${i.touched.subjects?i.errors.subjects?"error":"success":""}`,onClick:()=>A(k)},a.createElement("label",{"data-test":k},C(k)),a.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((H=F.find(e=>e.key==k))==null?void 0:H.values)||[],value:i.values.subjects,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:u.isFetching,isMulti:R(k),isSearchable:!0,isClearable:!0,isDisabled:!n.data||f(k),onChange:e=>i.setFieldValue(k,e),maxMenuHeight:180,menuPortalTarget:document.body,styles:{menuPortal:e=>({...e,zIndex:9999})}})),a.createElement("div",{hidden:!n.data||f(v),className:`form-group fade-in-quick${i.touched.storyPoints?i.errors.storyPoints?"error":"success":""}`},a.createElement("label",null,C(v)),a.createElement("input",{type:"number",className:"input",name:v,value:i.values.storyPoints,onChange:e=>i.setFieldValue(v,e.target.value),disabled:!n.data||f(v),"data-test":v})),a.createElement("div",{className:"sticky-bottom"},!T&&a.createElement("button",{type:"submit",disabled:L.isFetching,"data-test":"submit",className:`fade-in button button-primary ${L.isFetching?"button-loading":""}`,onClick:()=>i.handleSubmit()},"Save"),T&&a.createElement("span",null,a.createElement("svg",{className:"checkmark",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 52 52"},a.createElement("circle",{className:"checkmark__circle",cx:"26",cy:"26",r:"25",fill:"none"}),a.createElement("path",{className:"checkmark__check",fill:"none",d:"M14.1 27.2l7.1 7.2 16.7-16.8"}))))))))}const xe=s=>{const[t,h]=r.exports.useState([]);return a.useEffect(()=>{if(!s||!s.length)return;const d=[];for(let b of ke)d.push({key:b.name,value:!s.some(l=>l.trackerItemField==b.name||l.legacyRestName==b.legacyName)});h(d)},[s]),t};function Te(s){var S,y,T,w;Y();const[t]=r.exports.useState((y=(S=s.itemId)!=null?S:new URL(document.location.href).searchParams.get("itemId"))!=null?y:""),[h]=r.exports.useState((w=(T=s.cardId)!=null?T:new URL(document.location.href).searchParams.get("cardId"))!=null?w:""),[d,b]=r.exports.useState(null),[l,x]=fe();return r.exports.useEffect(()=>{if(!t||!h){console.error("Item page called without itemId and/or cardId in query."),b(r.exports.createElement("div",{className:"centered"},r.exports.createElement("p",null,"Something went wrong when opening the card details"),r.exports.createElement("p",null,"Please contact support")));return}},[]),d||(x?r.exports.createElement("div",{className:"centered loading-spinner-lg"}):l?r.exports.createElement(r.exports.Fragment,null,r.exports.createElement(Fe,{cardId:h,itemId:t}),r.exports.createElement(Ee,{position:"bottom-center"})):r.exports.createElement(ge,null))}function we(){return r.exports.createElement(de,{store:me},r.exports.createElement(ue,{showAuthWhileLoading:!1},r.exports.createElement(Te,null)))}const Le=document.getElementById("root"),Ae=ce(Le);Ae.render(r.exports.createElement(we,null));
