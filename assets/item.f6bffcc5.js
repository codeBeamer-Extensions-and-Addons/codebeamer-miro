import"./regular-expressions.11563385.js";import{u as fe,r as n,a as Ee,a3 as he,a4 as pe,a5 as be,a6 as ye,a7 as Se,B as t,Z as Ne,I as ve,a8 as Ie,S as x,g as X,$ as ke,a0 as Fe,a1 as Te,a2 as Le}from"./Toasts.dd02bba4.js";function ee(l,i="item"){return i.includes("Reference")&&(i=i.split("Reference")[0]),i.includes("Tracker")&&(i=i.split("Tracker")[1]),`/${i.toLowerCase()}/${l}`}function C(l){let i=l.split("/");return i[i.length-1]}function _(l){var i;if(!l.id&&!l.uri)throw new Error("Data must have either id or uri!");return{uri:(i=l.uri)!=null?i:ee(l.id,l.type),name:l.name}}const xe="assignedTo",g="assignedTo",Ce="team",h="teams",_e="storyPoints",I="storyPoints",Ae="versions",p="versions",we="realizedFeature",b="subjects",Me=[{label:"Assignee",name:g,legacyName:xe,type:"array"},{label:"Team",name:h,legacyName:Ce,type:"array"},{label:"Story Points",name:I,legacyName:_e,type:"number"},{label:"Version",name:p,legacyName:Ae,type:"array"},{label:"Subject",name:b,legacyName:we,type:"array"}];function Re(l){var $,B,H,Y,W,J,q,Z,K;const i=fe(),[A]=n.exports.useState((B=($=l.itemId)!=null?$:new URL(document.location.href).searchParams.get("itemId"))!=null?B:""),[k]=n.exports.useState((Y=(H=l.cardId)!=null?H:new URL(document.location.href).searchParams.get("cardId"))!=null?Y:""),[M,te]=n.exports.useState(!0),[a,ae]=n.exports.useState(),[f,se]=n.exports.useState([]),[R,P]=n.exports.useState(""),[O,re]=n.exports.useState(),[D,ie]=n.exports.useState(!0),[V,z]=n.exports.useState(!1),[F,Q]=n.exports.useState(""),[y,ne]=n.exports.useState([]),[j,le]=n.exports.useState([]),{cbAddress:G}=Ee(e=>e.boardSettings),[oe,o]=he(),[U,d]=pe(),[ce,u]=be(),[de,S]=ye(),[ue,T]=Se();t.useEffect(()=>{if(!A||!k){console.error("Item page called without itemId and/or cardId in query.");return}i(Ne())},[]),t.useEffect(()=>{G&&M&&(te(!1),U(A))},[G,M]),t.useEffect(()=>{if(o.error){console.error("Fatal error - couldn't load tracker schema: ",o.error),Q("Failed loading tracker schema");return}else o.data&&(se(o.data),N(g),ie(!1))},[o]),t.useEffect(()=>{if(!f||!f.length)return;const e=[];for(let r of Me)e.push({key:r.name,value:!f.some(c=>c.trackerItemField==r.name||c.legacyRestName==r.legacyName)});le(e)},[f]),t.useEffect(()=>{if(d.error){console.error("Fatal error - couldn't load item schema: ",d.error),Q("Failed loading item schema");return}else d.data&&(re(d.data.tracker.id.toString()),ae(d.data),(!f||!f.length)&&oe(d.data.tracker.id.toString()),R||(P(d.data.description),ue({itemId:d.data.id,markup:d.data.description})),ve(d.data,k))},[d]),t.useEffect(()=>{T.error&&console.warn("Failed to convert wiki description to html"),T.data&&P(T.data)},[T]),t.useEffect(()=>{S.error||S.data&&(U(A),z(!0),setTimeout(()=>{z(!1)},2e3))},[S]);const N=e=>{var c,E;if(y.find(m=>m.key==e)||((c=j.find(m=>m.key==e))==null?void 0:c.value)||!o.data||!O)return;const r=(E=o.data.find(m=>m.trackerItemField==e))==null?void 0:E.id;if(!r){console.warn("Can't find field for assignee in Tracker schema - therefore can't load options.");return}ce({trackerId:O,fieldId:r})};t.useEffect(()=>{u.error&&console.error(u.error)},[u.error]),t.useEffect(()=>{var e,r,c;if(u.data){const E=(e=u.originalArgs)==null?void 0:e.fieldId;if(!E)console.warn("Can't determine which field the received data are options for.");else{const m=(c=(r=o.data)==null?void 0:r.find(w=>w.id==E))==null?void 0:c.trackerItemField;if(!m){console.warn("Can't determine which field the received data are options for.");return}const ge=[...y.filter(w=>w.key!==m),{key:m,values:u.data}];ne(ge)}}},[u.data]);const v=e=>{var r,c;return(c=(r=j.find(E=>E.key==e))==null?void 0:r.value)!=null?c:!1},L=e=>{var r;return((r=f.find(c=>c.trackerItemField==e))==null?void 0:r.multipleValues)||!1},me=async()=>{const e={header:"Error",content:"Can't find the item on the board!",bg:"warning"};if(!k){i(X(e));return}let r=await miro.board.get({id:k});r.length||i(X(e)),miro.board.viewport.zoomTo(r)},s=Ie({initialValues:{assignedTo:a!=null&&a.assignedTo?a.assignedTo:[],teams:a!=null&&a.teams?a.teams:[],storyPoints:(W=a==null?void 0:a.storyPoints)!=null?W:-1,versions:a!=null&&a.versions?a.versions:[],subjects:a!=null&&a.subjects?a.subjects:[]},enableReinitialize:!0,validate:e=>({}),onSubmit:e=>{console.log("Submitting");const r={uri:ee(a.id),assignedTo:e.assignedTo.map(_),team:e.teams.map(_),versions:e.versions.map(_),realizedFeature:e.subjects.map(_),storyPoints:e.storyPoints};de(r)}});return t.createElement(t.Fragment,null,F&&t.createElement("div",{className:"centered","data-test":"fatal-error"},t.createElement("h3",{className:"h3"},"Fatal error"),t.createElement("p",null,F)),!F&&D&&t.createElement("div",{className:"centered loading-spinner-lg"}),!F&&!D&&a&&t.createElement("div",{className:"fade-in centered-horizontally h-100 flex-col w-85"},t.createElement("div",{className:"panel-header h-max-25"},t.createElement("div",{className:"panel-title sticky"},t.createElement("h3",{className:"h3"},a.name," ",t.createElement("small",null,"#",a.id)," ",t.createElement("span",{className:"icon icon-eye clickable pos-adjusted-down",title:"Click to zoom to the item",onClick:()=>me(),"data-test":"zoom-to-item"}))),t.createElement("p",{className:"overflow-ellipsis",dangerouslySetInnerHTML:{__html:R}})),t.createElement("hr",null),t.createElement("div",{className:"panel-content mt-1 h-64 overflow-auto"},t.createElement("h6",{className:"h6 pb-3"},"Editable attributes:"),t.createElement("form",{onSubmit:s.handleSubmit,className:"flex-col position-relative"},t.createElement("div",{className:`form-group ${s.touched.assignedTo?s.errors.assignedTo?"error":"success":""}`,onClick:()=>N(g)},t.createElement("label",{"data-test":g},"Assignee"),t.createElement(x,{className:"basic-single",classNamePrefix:"select",options:((J=y.find(e=>e.key==g))==null?void 0:J.values)||[],value:s.values.assignedTo,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?C(e.uri):"-1",isLoading:u.isFetching,isMulti:L(g),isSearchable:!0,isClearable:!0,isDisabled:!o.data||v(g),onChange:e=>s.setFieldValue(g,e),maxMenuHeight:180})),t.createElement("div",{className:`form-group ${s.touched.teams?s.errors.teams?"error":"success":""}`,onClick:()=>N(h)},t.createElement("label",{"data-test":h},"Team"),t.createElement(x,{className:"basic-single",classNamePrefix:"select",options:((q=y.find(e=>e.key==h))==null?void 0:q.values)||[],value:s.values.teams,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?C(e.uri):"-1",isLoading:u.isFetching,isMulti:L(h),isSearchable:!0,isClearable:!0,isDisabled:!o.data||v(h),onChange:e=>s.setFieldValue(h,e),maxMenuHeight:180})),t.createElement("div",{className:`form-group ${s.touched.versions?s.errors.versions?"error":"success":""}`,onClick:()=>N(p)},t.createElement("label",{"data-test":p},"Version"),t.createElement(x,{className:"basic-single",classNamePrefix:"select",options:((Z=y.find(e=>e.key==p))==null?void 0:Z.values)||[],value:s.values.versions,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?C(e.uri):"-1",isLoading:u.isFetching,isMulti:L(p),isSearchable:!0,isClearable:!0,isDisabled:!o.data||v(p),onChange:e=>s.setFieldValue(p,e),maxMenuHeight:180})),t.createElement("div",{className:`form-group ${s.touched.subjects?s.errors.subjects?"error":"success":""}`,onClick:()=>N(b)},t.createElement("label",{"data-test":b},"Subject"),t.createElement(x,{className:"basic-single",classNamePrefix:"select",options:((K=y.find(e=>e.key==b))==null?void 0:K.values)||[],value:s.values.subjects,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?C(e.uri):"-1",isLoading:u.isFetching,isMulti:L(b),isSearchable:!0,isClearable:!0,isDisabled:!o.data||v(b),onChange:e=>s.setFieldValue(b,e),maxMenuHeight:180})),t.createElement("div",{className:`form-group ${s.touched.storyPoints?s.errors.storyPoints?"error":"success":""}`},t.createElement("label",null,"Story Points"),t.createElement("input",{type:"number",className:"input",name:I,value:s.values.storyPoints,onChange:e=>s.setFieldValue(I,e.target.value),disabled:!o.data||v(I),"data-test":I})))),t.createElement("div",{className:"absolute-bottom"},!V&&t.createElement("button",{type:"submit",disabled:S.isFetching,"data-test":"submit",className:`fade-in button button-primary ${S.isFetching?"button-loading":""}`,onClick:()=>s.handleSubmit()},"Save"),V&&t.createElement("span",null,t.createElement("svg",{className:"checkmark",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 52 52"},t.createElement("circle",{className:"checkmark__circle",cx:"26",cy:"26",r:"25",fill:"none"}),t.createElement("path",{className:"checkmark__check",fill:"none",d:"M14.1 27.2l7.1 7.2 16.7-16.8"}))))))}function Pe(){return n.exports.createElement(Fe,{store:Te},n.exports.createElement(Re,null),n.exports.createElement(Le,{position:"bottom-center"}))}const Oe=document.getElementById("root"),De=ke(Oe);De.render(n.exports.createElement(Pe,null));
