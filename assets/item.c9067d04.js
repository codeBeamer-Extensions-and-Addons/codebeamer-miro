import"./regular-expressions.3b920edb.js";import{u as B,a as Y,r,O as te,R as t,Q as ae,I as se,U as re,V as ne,W as ie,X as oe,i as le,Y as ce,S as M,J as de,K as me,L as ue,N as fe,H as ge,A as Ee,T as he}from"./BoardSettingsLoader.61eda9a2.js";function q(s,a="item"){return a.includes("Reference")&&(a=a.split("Reference")[0]),a.includes("Tracker")&&(a=a.split("Tracker")[1]),`/${a.toLowerCase()}/${s}`}function P(s){let a=s.split("/");return a[a.length-1]}function O(s){var a;if(!s.id&&!s.uri)throw new Error("Data must have either id or uri!");return{uri:(a=s.uri)!=null?a:q(s.id,s.type),name:s.name}}const be="assignedTo",p="assignedTo",ye="team",I="teams",pe="storyPoints",L="storyPoints",Ie="versions",S="versions",Se="realizedFeature",k="subjects",ke=[{label:"Assignee",name:p,legacyName:be,type:"array"},{label:"Team",name:I,legacyName:ye,type:"array"},{label:"Story Points",name:L,legacyName:pe,type:"number"},{label:"Version",name:S,legacyName:Ie,type:"array"},{label:"Subject",name:k,legacyName:Se,type:"array"}];const Ne=/href\=\"\/cb/g,ve=/src\=\"\/cb/g;function xe(s,a){return a=a.replaceAll(Ne,`href="${s}`),a=a.replaceAll(ve,`src="${s}`),a=a.replaceAll(/\<a /g,'<a target="_blank" '),a}function Fe(s){var c;B();const{cbAddress:a}=Y(f=>f.boardSettings),[m,d]=r.exports.useState((c=s.item.description)!=null?c:""),[E,l]=te();t.useEffect(()=>{!s.item.id||!s.item.description||E({itemId:s.item.id,markup:s.item.description})},[s.item.description]),t.useEffect(()=>{l.error&&console.warn("Failed to convert wiki description to html"),l.data&&d(a?xe(a,l.data):l.data)},[l]);const x=async()=>{if(!s.cardId){miro.board.notifications.showError("Can't zoom to the Item, since its card Id is unknown");return}let f=await miro.board.getById(s.cardId);f||miro.board.notifications.showError("Can't zoom to the Item, since it doesn't exist on the board"),miro.board.viewport.zoomTo(f)};return t.createElement(t.Fragment,null,t.createElement("div",{className:"title sticky"},t.createElement("h3",{className:"h3","data-test":"summary-summary"},s.item.name,s.item.id&&t.createElement("small",null," #",s.item.id," "),s.cardId&&t.createElement("span",{className:"icon icon-eye clickable pos-adjusted-down",title:"Click to zoom to the item",onClick:()=>x(),"data-test":"summary-zoom-to-item"}))),m&&t.createElement("p",{"data-test":"summary-description",className:"overflow-ellipsis",dangerouslySetInnerHTML:{__html:m}}))}function we(s){const[a,m]=r.exports.useState(!0),[d,E]=r.exports.useState([]),[l,x]=r.exports.useState(""),{data:c,error:f,isLoading:N}=ae(s.itemId),F=()=>{if(c&&!a){const w=c.downstreamReferences.map(_=>_.itemRevision.id.toString());E(w),x(`item.id IN (${w.join(",")})`)}else console.warn("Can't load Downstream References - data still loading or failed to do so.")};return t.useEffect(()=>{if(f){m(!0);return}else c&&(c.downstreamReferences.length?m(!1):m(!0))},[c,f]),t.createElement("div",{className:"flex-centered"},t.createElement("button",{className:`button button-tertiary ${N?"button-loading button-loading-primary":""}`,onClick:F,disabled:a,"data-test":"load-downstream-references",title:"Load the Item's Downstream References onto the board, if they're not yet there"},!N&&t.createElement(t.Fragment,null,t.createElement("span",{className:"icon-add-row-bottom"}),t.createElement("span",null,"Load Downstream References")),c&&` (${c.downstreamReferences.length})`),l&&t.createElement(se,{items:d,queryString:l}))}function Le(s){var $,G,j,H,U;const[a,m]=r.exports.useState(),[d,E]=r.exports.useState([]),[l,x]=r.exports.useState(),[c,f]=r.exports.useState(!0),[N,F]=r.exports.useState(!1),[w,_]=r.exports.useState(""),[T,W]=r.exports.useState([]),Q=Te(d),{cbAddress:J}=Y(e=>e.boardSettings),[V,v]=re(),[K,i]=ne(),[X,h]=ie(),[Z,A]=oe();t.useEffect(()=>{V(s.itemId)},[]),t.useEffect(()=>{if(i.error){console.error("Fatal error - couldn't load tracker schema: ",i.error),_("Failed loading tracker schema");return}else i.data&&(E(i.data),C(p),f(!1))},[i]),t.useEffect(()=>{v.error?(console.error("Fatal error - couldn't load Item data",v.error),_(`Failed loading Item data from ${J} for Item with Id ${s.itemId}`)):v.data&&(m(v.data),x(v.data.tracker.id.toString()),(!d||!d.length)&&!i.isFetching&&K(v.data.tracker.id),le(v.data,s.cardId))},[v]),t.useEffect(()=>{A.error||A.data&&(V(s.itemId),F(!0),setTimeout(()=>{F(!1)},2e3))},[A]);const C=e=>{var u,y;if(T.find(g=>g.key==e)||((u=Q.find(g=>g.key==e))==null?void 0:u.value)||!i.data||!l)return;const o=(y=i.data.find(g=>g.trackerItemField==e))==null?void 0:y.id;if(!o){const g=`Can't find field for ${e} in Tracker schema - therefore can't load options.`;console.warn(g),miro.board.notifications.showError(g);return}X({trackerId:l,fieldId:o})};t.useEffect(()=>{h.error&&(console.error(h.error),miro.board.notifications.showError("Failed loading options"))},[h.error]),t.useEffect(()=>{var e,o,u;if(h.data){const y=(e=h.originalArgs)==null?void 0:e.fieldId;if(!y)console.warn("Can't determine which field the received data are options for.");else{const g=(u=(o=i.data)==null?void 0:o.find(z=>z.id==y))==null?void 0:u.trackerItemField;if(!g){console.warn("Can't determine which field the received data are options for.");return}const ee=[...T.filter(z=>z.key!==g),{key:g,values:h.data}];W(ee)}}},[h.data]);const R=e=>{var u;if(!i.data)return e;let o=(u=i.data.find(y=>y.legacyRestName==e||y.trackerItemField==e))==null?void 0:u.name;return o!=null?o:e},b=e=>{var o,u;return(u=(o=Q.find(y=>y.key==e))==null?void 0:o.value)!=null?u:!1},D=e=>{var o;return((o=d.find(u=>u.trackerItemField==e))==null?void 0:o.multipleValues)||!1},n=ce({initialValues:{assignedTo:a!=null&&a.assignedTo?a.assignedTo:[],teams:a!=null&&a.teams?a.teams:[],storyPoints:($=a==null?void 0:a.storyPoints)!=null?$:-1,versions:a!=null&&a.versions?a.versions:[],subjects:a!=null&&a.subjects?a.subjects:[]},enableReinitialize:!0,validate:e=>({}),onSubmit:e=>{console.log("Submitting");const o={uri:q(a.id),assignedTo:e.assignedTo.map(O),team:e.teams.map(O),versions:e.versions.map(O),realizedFeature:e.subjects.map(O),storyPoints:e.storyPoints};Z(o)}});return t.createElement(t.Fragment,null,w&&t.createElement("div",{className:"centered","data-test":"fatal-error"},t.createElement("h3",{className:"h3"},"Fatal error"),t.createElement("p",null,w)),!w&&c&&t.createElement("div",{className:"centered loading-spinner-lg"}),!w&&!c&&a&&t.createElement("div",{className:"fade-in centered-horizontally h-100 flex-col w-85"},t.createElement("div",{className:"panel-header h-max-25"},t.createElement(Fe,{item:a,cardId:s.cardId})),t.createElement("div",{className:"mt-4"},t.createElement(we,{itemId:s.itemId})),t.createElement("hr",null),t.createElement("div",{className:"panel-content mt-1 h-75 overflow-auto"},t.createElement("form",{onSubmit:n.handleSubmit,className:"flex-col position-relative h-100"},t.createElement("h6",{className:"h6 pb-3"},"Editable attributes:"),t.createElement("div",{hidden:!i.data||b(p),className:`form-group fade-in-quick${n.touched.assignedTo?n.errors.assignedTo?"error":"success":""}`,onClick:()=>C(p)},t.createElement("label",{"data-test":p},R(p)),t.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((G=T.find(e=>e.key==p))==null?void 0:G.values)||[],value:n.values.assignedTo,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:h.isFetching,isMulti:D(p),isSearchable:!0,isClearable:!0,isDisabled:!i.data||b(p),onChange:e=>n.setFieldValue(p,e),maxMenuHeight:180})),t.createElement("div",{hidden:!i.data||b(I),className:`form-group fade-in-quick${n.touched.teams?n.errors.teams?"error":"success":""}`,onClick:()=>C(I)},t.createElement("label",{"data-test":I},R(I)),t.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((j=T.find(e=>e.key==I))==null?void 0:j.values)||[],value:n.values.teams,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:h.isFetching,isMulti:D(I),isSearchable:!0,isClearable:!0,isDisabled:!i.data||b(I),onChange:e=>n.setFieldValue(I,e),maxMenuHeight:180})),t.createElement("div",{hidden:!i.data||b(S),className:`form-group fade-in-quick${n.touched.versions?n.errors.versions?"error":"success":""}`,onClick:()=>C(S)},t.createElement("label",{"data-test":S},R(S)),t.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((H=T.find(e=>e.key==S))==null?void 0:H.values)||[],value:n.values.versions,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:h.isFetching,isMulti:D(S),isSearchable:!0,isClearable:!0,isDisabled:!i.data||b(S),onChange:e=>n.setFieldValue(S,e),maxMenuHeight:180})),t.createElement("div",{hidden:!i.data||b(k),className:`form-group fade-in-quick${n.touched.subjects?n.errors.subjects?"error":"success":""}`,onClick:()=>C(k)},t.createElement("label",{"data-test":k},R(k)),t.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((U=T.find(e=>e.key==k))==null?void 0:U.values)||[],value:n.values.subjects,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:h.isFetching,isMulti:D(k),isSearchable:!0,isClearable:!0,isDisabled:!i.data||b(k),onChange:e=>n.setFieldValue(k,e),maxMenuHeight:180,menuPortalTarget:document.body,styles:{menuPortal:e=>({...e,zIndex:9999})}})),t.createElement("div",{hidden:!i.data||b(L),className:`form-group fade-in-quick${n.touched.storyPoints?n.errors.storyPoints?"error":"success":""}`},t.createElement("label",null,R(L)),t.createElement("input",{type:"number",className:"input",name:L,value:n.values.storyPoints,onChange:e=>n.setFieldValue(L,e.target.value),disabled:!i.data||b(L),"data-test":L})),t.createElement("div",{className:"sticky-bottom"},!N&&t.createElement("button",{type:"submit",disabled:A.isFetching,"data-test":"submit",className:`fade-in button button-primary ${A.isFetching?"button-loading":""}`,onClick:()=>n.handleSubmit()},"Save"),N&&t.createElement("span",null,t.createElement("svg",{className:"checkmark",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 52 52"},t.createElement("circle",{className:"checkmark__circle",cx:"26",cy:"26",r:"25",fill:"none"}),t.createElement("path",{className:"checkmark__check",fill:"none",d:"M14.1 27.2l7.1 7.2 16.7-16.8"}))))))))}const Te=s=>{const[a,m]=r.exports.useState([]);return t.useEffect(()=>{if(!s||!s.length)return;const d=[];for(let E of ke)d.push({key:E.name,value:!s.some(l=>l.trackerItemField==E.name||l.legacyRestName==E.legacyName)});m(d)},[s]),a};function Ae(s){var c,f,N,F;B();const[a]=r.exports.useState((f=(c=s.itemId)!=null?c:new URL(document.location.href).searchParams.get("itemId"))!=null?f:""),[m]=r.exports.useState((F=(N=s.cardId)!=null?N:new URL(document.location.href).searchParams.get("cardId"))!=null?F:""),[d,E]=r.exports.useState(null),[l,x]=ge();return r.exports.useEffect(()=>{if(!a||!m){console.error("Item page called without itemId and/or cardId in query."),E(r.exports.createElement("div",{className:"centered"},r.exports.createElement("p",null,"Something went wrong when opening the card details"),r.exports.createElement("p",null,"Please contact support")));return}},[]),d||(x?r.exports.createElement("div",{className:"centered loading-spinner-lg"}):l?r.exports.createElement(r.exports.Fragment,null,r.exports.createElement(Le,{cardId:m,itemId:a}),r.exports.createElement(he,{position:"bottom-center"})):r.exports.createElement(Ee,null))}function Ce(){return r.exports.createElement(me,{store:ue},r.exports.createElement(fe,{showAuthWhileLoading:!1},r.exports.createElement(Ae,null)))}const Re=document.getElementById("root"),_e=de(Re);_e.render(r.exports.createElement(Ce,null));
