import"./regular-expressions.3b920edb.js";import{u as Y,a as q,r,O as ae,R as a,Q as se,I as re,U as ie,V as ne,W as oe,X as le,i as ce,Y as de,S as M,J as me,K as ue,L as fe,N as ge,H as Ee,A as he,T as be}from"./BoardSettingsLoader.8386953d.js";function W(s,t="item"){return t.includes("Reference")&&(t=t.split("Reference")[0]),t.includes("Tracker")&&(t=t.split("Tracker")[1]),`/${t.toLowerCase()}/${s}`}function P(s){let t=s.split("/");return t[t.length-1]}function D(s){var t;if(!s.id&&!s.uri)throw new Error("Data must have either id or uri!");return{uri:(t=s.uri)!=null?t:W(s.id,s.type),name:s.name}}const ye="assignedTo",p="assignedTo",Ie="team",S="teams",pe="storyPoints",x="storyPoints",Se="versions",k="versions",ke="realizedFeature",N="subjects",Ne=[{label:"Assignee",name:p,legacyName:ye,type:"array"},{label:"Team",name:S,legacyName:Ie,type:"array"},{label:"Story Points",name:x,legacyName:pe,type:"number"},{label:"Version",name:k,legacyName:Se,type:"array"},{label:"Subject",name:N,legacyName:ke,type:"array"}];const B=/href\=\"\/cb/g,ve=/src\=\"\/cb/g;function xe(s,t){return console.log(t.match(B)),t=t.replaceAll(B,`href="${s}`),t=t.replaceAll(ve,`src="${s}`),t=t.replaceAll(/\<a /g,'<a target="_blank" '),t}function Fe(s){var b;Y();const{cbAddress:t}=q(g=>g.boardSettings),[u,l]=r.exports.useState((b=s.item.description)!=null?b:""),[f,c]=ae();a.useEffect(()=>{!s.item.id||!s.item.description||f({itemId:s.item.id,markup:s.item.description})},[s.item.description]),a.useEffect(()=>{c.error&&console.warn("Failed to convert wiki description to html"),c.data&&l(t?xe(t,c.data):c.data)},[c]);const h=async()=>{if(!s.cardId){miro.board.notifications.showError("Can't zoom to the Item, since its card Id is unknown");return}let g=await miro.board.getById(s.cardId);g||miro.board.notifications.showError("Can't zoom to the Item, since it doesn't exist on the board"),miro.board.viewport.zoomTo(g)};return a.createElement(a.Fragment,null,a.createElement("div",{className:"title sticky"},a.createElement("h3",{className:"h3","data-test":"summary-summary"},s.item.name,s.item.id&&a.createElement("small",null," #",s.item.id," "),s.cardId&&a.createElement("span",{className:"icon icon-eye clickable pos-adjusted-down",title:"Click to zoom to the item",onClick:()=>h(),"data-test":"summary-zoom-to-item"}))),u&&a.createElement("p",{"data-test":"summary-description",className:"overflow-ellipsis",dangerouslySetInnerHTML:{__html:u}}))}function we(s){const[t,u]=r.exports.useState([]),[l,f]=r.exports.useState(""),[c,h]=se(),b=()=>{c(s.itemId)};return a.useEffect(()=>{h.error||h.data&&u(h.data.downstreamReferences.map(g=>g.itemRevision.id.toString()))},[h]),a.useEffect(()=>{t.length&&f(`item.id IN (${t.join(",")})`)},[t]),a.createElement("div",{className:"flex-centered"},a.createElement("button",{className:"button button-tertiary",onClick:b},a.createElement("span",{className:"icon-add-row-bottom"}),"Load Downstream References"),l&&a.createElement(re,{items:t,queryString:l}))}function Le(s){var $,G,j,H,U;const[t,u]=r.exports.useState(),[l,f]=r.exports.useState([]),[c,h]=r.exports.useState(),[b,g]=r.exports.useState(!0),[w,L]=r.exports.useState(!1),[R,z]=r.exports.useState(""),[F,J]=r.exports.useState([]),Q=Te(l),{cbAddress:K}=q(e=>e.boardSettings),[V,v]=ie(),[X,n]=ne(),[Z,E]=oe(),[ee,T]=le();a.useEffect(()=>{V(s.itemId)},[]),a.useEffect(()=>{if(n.error){console.error("Fatal error - couldn't load tracker schema: ",n.error),z("Failed loading tracker schema");return}else n.data&&(f(n.data),A(p),g(!1))},[n]),a.useEffect(()=>{v.error?(console.error("Fatal error - couldn't load Item data",v.error),z(`Failed loading Item data from ${K} for Item with Id ${s.itemId}`)):v.data&&(u(v.data),h(v.data.tracker.id.toString()),(!l||!l.length)&&!n.isFetching&&X(v.data.tracker.id),ce(v.data,s.cardId))},[v]),a.useEffect(()=>{T.error||T.data&&(V(s.itemId),L(!0),setTimeout(()=>{L(!1)},2e3))},[T]);const A=e=>{var d,I;if(F.find(m=>m.key==e)||((d=Q.find(m=>m.key==e))==null?void 0:d.value)||!n.data||!c)return;const o=(I=n.data.find(m=>m.trackerItemField==e))==null?void 0:I.id;if(!o){const m=`Can't find field for ${e} in Tracker schema - therefore can't load options.`;console.warn(m),miro.board.notifications.showError(m);return}Z({trackerId:c,fieldId:o})};a.useEffect(()=>{E.error&&(console.error(E.error),miro.board.notifications.showError("Failed loading options"))},[E.error]),a.useEffect(()=>{var e,o,d;if(E.data){const I=(e=E.originalArgs)==null?void 0:e.fieldId;if(!I)console.warn("Can't determine which field the received data are options for.");else{const m=(d=(o=n.data)==null?void 0:o.find(O=>O.id==I))==null?void 0:d.trackerItemField;if(!m){console.warn("Can't determine which field the received data are options for.");return}const te=[...F.filter(O=>O.key!==m),{key:m,values:E.data}];J(te)}}},[E.data]);const C=e=>{var d;if(!n.data)return e;let o=(d=n.data.find(I=>I.legacyRestName==e||I.trackerItemField==e))==null?void 0:d.name;return o!=null?o:e},y=e=>{var o,d;return(d=(o=Q.find(I=>I.key==e))==null?void 0:o.value)!=null?d:!1},_=e=>{var o;return((o=l.find(d=>d.trackerItemField==e))==null?void 0:o.multipleValues)||!1},i=de({initialValues:{assignedTo:t!=null&&t.assignedTo?t.assignedTo:[],teams:t!=null&&t.teams?t.teams:[],storyPoints:($=t==null?void 0:t.storyPoints)!=null?$:-1,versions:t!=null&&t.versions?t.versions:[],subjects:t!=null&&t.subjects?t.subjects:[]},enableReinitialize:!0,validate:e=>({}),onSubmit:e=>{console.log("Submitting");const o={uri:W(t.id),assignedTo:e.assignedTo.map(D),team:e.teams.map(D),versions:e.versions.map(D),realizedFeature:e.subjects.map(D),storyPoints:e.storyPoints};ee(o)}});return a.createElement(a.Fragment,null,R&&a.createElement("div",{className:"centered","data-test":"fatal-error"},a.createElement("h3",{className:"h3"},"Fatal error"),a.createElement("p",null,R)),!R&&b&&a.createElement("div",{className:"centered loading-spinner-lg"}),!R&&!b&&t&&a.createElement("div",{className:"fade-in centered-horizontally h-100 flex-col w-85"},a.createElement("div",{className:"panel-header h-max-25"},a.createElement(Fe,{item:t,cardId:s.cardId})),a.createElement("div",{className:"mt-4"},a.createElement(we,{itemId:s.itemId})),a.createElement("hr",null),a.createElement("div",{className:"panel-content mt-1 h-75 overflow-auto"},a.createElement("form",{onSubmit:i.handleSubmit,className:"flex-col position-relative h-100"},a.createElement("h6",{className:"h6 pb-3"},"Editable attributes:"),a.createElement("div",{hidden:!n.data||y(p),className:`form-group fade-in-quick${i.touched.assignedTo?i.errors.assignedTo?"error":"success":""}`,onClick:()=>A(p)},a.createElement("label",{"data-test":p},C(p)),a.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((G=F.find(e=>e.key==p))==null?void 0:G.values)||[],value:i.values.assignedTo,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:E.isFetching,isMulti:_(p),isSearchable:!0,isClearable:!0,isDisabled:!n.data||y(p),onChange:e=>i.setFieldValue(p,e),maxMenuHeight:180})),a.createElement("div",{hidden:!n.data||y(S),className:`form-group fade-in-quick${i.touched.teams?i.errors.teams?"error":"success":""}`,onClick:()=>A(S)},a.createElement("label",{"data-test":S},C(S)),a.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((j=F.find(e=>e.key==S))==null?void 0:j.values)||[],value:i.values.teams,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:E.isFetching,isMulti:_(S),isSearchable:!0,isClearable:!0,isDisabled:!n.data||y(S),onChange:e=>i.setFieldValue(S,e),maxMenuHeight:180})),a.createElement("div",{hidden:!n.data||y(k),className:`form-group fade-in-quick${i.touched.versions?i.errors.versions?"error":"success":""}`,onClick:()=>A(k)},a.createElement("label",{"data-test":k},C(k)),a.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((H=F.find(e=>e.key==k))==null?void 0:H.values)||[],value:i.values.versions,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:E.isFetching,isMulti:_(k),isSearchable:!0,isClearable:!0,isDisabled:!n.data||y(k),onChange:e=>i.setFieldValue(k,e),maxMenuHeight:180})),a.createElement("div",{hidden:!n.data||y(N),className:`form-group fade-in-quick${i.touched.subjects?i.errors.subjects?"error":"success":""}`,onClick:()=>A(N)},a.createElement("label",{"data-test":N},C(N)),a.createElement(M,{className:"basic-single",classNamePrefix:"select",options:((U=F.find(e=>e.key==N))==null?void 0:U.values)||[],value:i.values.subjects,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?P(e.uri):"-1",isLoading:E.isFetching,isMulti:_(N),isSearchable:!0,isClearable:!0,isDisabled:!n.data||y(N),onChange:e=>i.setFieldValue(N,e),maxMenuHeight:180,menuPortalTarget:document.body,styles:{menuPortal:e=>({...e,zIndex:9999})}})),a.createElement("div",{hidden:!n.data||y(x),className:`form-group fade-in-quick${i.touched.storyPoints?i.errors.storyPoints?"error":"success":""}`},a.createElement("label",null,C(x)),a.createElement("input",{type:"number",className:"input",name:x,value:i.values.storyPoints,onChange:e=>i.setFieldValue(x,e.target.value),disabled:!n.data||y(x),"data-test":x})),a.createElement("div",{className:"sticky-bottom"},!w&&a.createElement("button",{type:"submit",disabled:T.isFetching,"data-test":"submit",className:`fade-in button button-primary ${T.isFetching?"button-loading":""}`,onClick:()=>i.handleSubmit()},"Save"),w&&a.createElement("span",null,a.createElement("svg",{className:"checkmark",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 52 52"},a.createElement("circle",{className:"checkmark__circle",cx:"26",cy:"26",r:"25",fill:"none"}),a.createElement("path",{className:"checkmark__check",fill:"none",d:"M14.1 27.2l7.1 7.2 16.7-16.8"}))))))))}const Te=s=>{const[t,u]=r.exports.useState([]);return a.useEffect(()=>{if(!s||!s.length)return;const l=[];for(let f of Ne)l.push({key:f.name,value:!s.some(c=>c.trackerItemField==f.name||c.legacyRestName==f.legacyName)});u(l)},[s]),t};function Ae(s){var b,g,w,L;Y();const[t]=r.exports.useState((g=(b=s.itemId)!=null?b:new URL(document.location.href).searchParams.get("itemId"))!=null?g:""),[u]=r.exports.useState((L=(w=s.cardId)!=null?w:new URL(document.location.href).searchParams.get("cardId"))!=null?L:""),[l,f]=r.exports.useState(null),[c,h]=Ee();return r.exports.useEffect(()=>{if(!t||!u){console.error("Item page called without itemId and/or cardId in query."),f(r.exports.createElement("div",{className:"centered"},r.exports.createElement("p",null,"Something went wrong when opening the card details"),r.exports.createElement("p",null,"Please contact support")));return}},[]),l||(h?r.exports.createElement("div",{className:"centered loading-spinner-lg"}):c?r.exports.createElement(r.exports.Fragment,null,r.exports.createElement(Le,{cardId:u,itemId:t}),r.exports.createElement(be,{position:"bottom-center"})):r.exports.createElement(he,null))}function Ce(){return r.exports.createElement(ue,{store:fe},r.exports.createElement(ge,{showAuthWhileLoading:!1},r.exports.createElement(Ae,null)))}const Re=document.getElementById("root"),_e=me(Re);_e.render(r.exports.createElement(Ce,null));
