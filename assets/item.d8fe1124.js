import"./regular-expressions.11563385.js";import{u as ae,a as se,r as l,a3 as ge,B as t,g as ee,a4 as fe,a5 as he,a6 as Ee,a7 as be,Z as ye,I as pe,a8 as Ie,S as w,$ as Se,a0 as ke,a1 as Ne,a2 as ve}from"./Toasts.fec270af.js";function re(a,r="item"){return r.includes("Reference")&&(r=r.split("Reference")[0]),r.includes("Tracker")&&(r=r.split("Tracker")[1]),`/${r.toLowerCase()}/${a}`}function M(a){let r=a.split("/");return r[r.length-1]}function R(a){var r;if(!a.id&&!a.uri)throw new Error("Data must have either id or uri!");return{uri:(r=a.uri)!=null?r:re(a.id,a.type),name:a.name}}const Fe="assignedTo",f="assignedTo",Te="team",E="teams",xe="storyPoints",S="storyPoints",Le="versions",b="versions",Ae="realizedFeature",y="subjects",Ce=[{label:"Assignee",name:f,legacyName:Fe,type:"array"},{label:"Team",name:E,legacyName:Te,type:"array"},{label:"Story Points",name:S,legacyName:xe,type:"number"},{label:"Version",name:b,legacyName:Le,type:"array"},{label:"Subject",name:y,legacyName:Ae,type:"array"}];const te=/href\=\"\/cb/g,_e=/src\=\"\/cb/g;function we(a,r){return console.log(r.match(te)),r=r.replaceAll(te,`href="${a}`),r=r.replaceAll(_e,`src="${a}`),r=r.replaceAll(/\<a /g,'<a target="_blank" '),r}function Me(a){var m;const r=ae(),{cbAddress:I}=se(N=>N.boardSettings),[k,A]=l.exports.useState((m=a.item.description)!=null?m:""),[O,s]=ge();t.useEffect(()=>{!a.item.id||!a.item.description||O({itemId:a.item.id,markup:a.item.description})},[a.item.description]),t.useEffect(()=>{s.error&&console.warn("Failed to convert wiki description to html"),s.data&&A(I?we(I,s.data):s.data)},[s]);const P=async()=>{const N={header:"Error",content:"Can't find the item on the board!",bg:"warning"};if(!a.cardId){r(ee(N));return}let F=await miro.board.getById(a.cardId);F||r(ee(N)),miro.board.viewport.zoomTo(F)};return t.createElement(t.Fragment,null,t.createElement("div",{className:"title sticky"},t.createElement("h3",{className:"h3","data-test":"summary-summary"},a.item.name,a.item.id&&t.createElement("small",null," #",a.item.id," "),a.cardId&&t.createElement("span",{className:"icon icon-eye clickable pos-adjusted-down",title:"Click to zoom to the item",onClick:()=>P(),"data-test":"summary-zoom-to-item"}))),k&&t.createElement("p",{"data-test":"summary-description",className:"overflow-ellipsis",dangerouslySetInnerHTML:{__html:k}}))}function Re(a){var H,U,Y,q,W,J,Z,K,X;const r=ae(),[I]=l.exports.useState((U=(H=a.itemId)!=null?H:new URL(document.location.href).searchParams.get("itemId"))!=null?U:""),[k]=l.exports.useState((q=(Y=a.cardId)!=null?Y:new URL(document.location.href).searchParams.get("cardId"))!=null?q:""),[A,O]=l.exports.useState(!0),[s,P]=l.exports.useState(),[m,N]=l.exports.useState([]);l.exports.useState("");const[F,ie]=l.exports.useState(),[V,ne]=l.exports.useState(!0),[Q,$]=l.exports.useState(!1),[C,G]=l.exports.useState(""),[v,oe]=l.exports.useState([]),[j,le]=l.exports.useState([]),{cbAddress:D}=se(e=>e.boardSettings),[ce,o]=fe(),[B,p]=he(),[de,d]=Ee(),[me,T]=be();t.useEffect(()=>{if(!I||!k){console.error("Item page called without itemId and/or cardId in query.");return}r(ye())},[]),t.useEffect(()=>{D&&A&&(O(!1),B(I))},[D,A]),t.useEffect(()=>{if(o.error){console.error("Fatal error - couldn't load tracker schema: ",o.error),G("Failed loading tracker schema");return}else o.data&&(N(o.data),x(f),ne(!1))},[o]),t.useEffect(()=>{if(!m||!m.length)return;const e=[];for(let n of Ce)e.push({key:n.name,value:!m.some(c=>c.trackerItemField==n.name||c.legacyRestName==n.legacyName)});le(e)},[m]),t.useEffect(()=>{p.error?(console.error("Fatal error - couldn't load item schema: ",p.error),G(`Failed loading item schema from ${D} for Item with Id ${I}`)):p.data&&(ie(p.data.tracker.id.toString()),P(p.data),(!m||!m.length)&&ce(p.data.tracker.id.toString()),pe(p.data,k))},[p]),t.useEffect(()=>{T.error||T.data&&(B(I),$(!0),setTimeout(()=>{$(!1)},2e3))},[T]);const x=e=>{var c,g;if(v.find(h=>h.key==e)||((c=j.find(h=>h.key==e))==null?void 0:c.value)||!o.data||!F)return;const n=(g=o.data.find(h=>h.trackerItemField==e))==null?void 0:g.id;if(!n){console.warn("Can't find field for assignee in Tracker schema - therefore can't load options.");return}de({trackerId:F,fieldId:n})};t.useEffect(()=>{d.error&&console.error(d.error)},[d.error]),t.useEffect(()=>{var e,n,c;if(d.data){const g=(e=d.originalArgs)==null?void 0:e.fieldId;if(!g)console.warn("Can't determine which field the received data are options for.");else{const h=(c=(n=o.data)==null?void 0:n.find(z=>z.id==g))==null?void 0:c.trackerItemField;if(!h){console.warn("Can't determine which field the received data are options for.");return}const ue=[...v.filter(z=>z.key!==h),{key:h,values:d.data}];oe(ue)}}},[d.data]);const L=e=>{var c;if(!o.data)return e;let n=(c=o.data.find(g=>g.legacyRestName==e||g.trackerItemField==e))==null?void 0:c.name;return n!=null?n:e},u=e=>{var n,c;return(c=(n=j.find(g=>g.key==e))==null?void 0:n.value)!=null?c:!1},_=e=>{var n;return((n=m.find(c=>c.trackerItemField==e))==null?void 0:n.multipleValues)||!1},i=Ie({initialValues:{assignedTo:s!=null&&s.assignedTo?s.assignedTo:[],teams:s!=null&&s.teams?s.teams:[],storyPoints:(W=s==null?void 0:s.storyPoints)!=null?W:-1,versions:s!=null&&s.versions?s.versions:[],subjects:s!=null&&s.subjects?s.subjects:[]},enableReinitialize:!0,validate:e=>({}),onSubmit:e=>{console.log("Submitting");const n={uri:re(s.id),assignedTo:e.assignedTo.map(R),team:e.teams.map(R),versions:e.versions.map(R),realizedFeature:e.subjects.map(R),storyPoints:e.storyPoints};me(n)}});return t.createElement(t.Fragment,null,C&&t.createElement("div",{className:"centered","data-test":"fatal-error"},t.createElement("h3",{className:"h3"},"Fatal error"),t.createElement("p",null,C)),!C&&V&&t.createElement("div",{className:"centered loading-spinner-lg"}),!C&&!V&&s&&t.createElement("div",{className:"fade-in centered-horizontally h-100 flex-col w-85"},t.createElement("div",{className:"panel-header h-max-25"},t.createElement(Me,{item:s,canZoomToItem:!0,cardId:k})),t.createElement("hr",null),t.createElement("div",{className:"panel-content mt-1 h-64 overflow-auto"},t.createElement("h6",{className:"h6 pb-3"},"Editable attributes:"),t.createElement("form",{onSubmit:i.handleSubmit,className:"flex-col position-relative"},t.createElement("div",{hidden:!o.data||u(f),className:`form-group fade-in-quick${i.touched.assignedTo?i.errors.assignedTo?"error":"success":""}`,onClick:()=>x(f)},t.createElement("label",{"data-test":f},L(f)),t.createElement(w,{className:"basic-single",classNamePrefix:"select",options:((J=v.find(e=>e.key==f))==null?void 0:J.values)||[],value:i.values.assignedTo,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?M(e.uri):"-1",isLoading:d.isFetching,isMulti:_(f),isSearchable:!0,isClearable:!0,isDisabled:!o.data||u(f),onChange:e=>i.setFieldValue(f,e),maxMenuHeight:180})),t.createElement("div",{hidden:!o.data||u(E),className:`form-group fade-in-quick${i.touched.teams?i.errors.teams?"error":"success":""}`,onClick:()=>x(E)},t.createElement("label",{"data-test":E},L(E)),t.createElement(w,{className:"basic-single",classNamePrefix:"select",options:((Z=v.find(e=>e.key==E))==null?void 0:Z.values)||[],value:i.values.teams,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?M(e.uri):"-1",isLoading:d.isFetching,isMulti:_(E),isSearchable:!0,isClearable:!0,isDisabled:!o.data||u(E),onChange:e=>i.setFieldValue(E,e),maxMenuHeight:180})),t.createElement("div",{hidden:!o.data||u(b),className:`form-group fade-in-quick${i.touched.versions?i.errors.versions?"error":"success":""}`,onClick:()=>x(b)},t.createElement("label",{"data-test":b},L(b)),t.createElement(w,{className:"basic-single",classNamePrefix:"select",options:((K=v.find(e=>e.key==b))==null?void 0:K.values)||[],value:i.values.versions,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?M(e.uri):"-1",isLoading:d.isFetching,isMulti:_(b),isSearchable:!0,isClearable:!0,isDisabled:!o.data||u(b),onChange:e=>i.setFieldValue(b,e),maxMenuHeight:180})),t.createElement("div",{hidden:!o.data||u(y),className:`form-group fade-in-quick${i.touched.subjects?i.errors.subjects?"error":"success":""}`,onClick:()=>x(y)},t.createElement("label",{"data-test":y},L(y)),t.createElement(w,{className:"basic-single",classNamePrefix:"select",options:((X=v.find(e=>e.key==y))==null?void 0:X.values)||[],value:i.values.subjects,getOptionLabel:e=>e.name,getOptionValue:e=>e.id?e.id.toString():e.uri?M(e.uri):"-1",isLoading:d.isFetching,isMulti:_(y),isSearchable:!0,isClearable:!0,isDisabled:!o.data||u(y),onChange:e=>i.setFieldValue(y,e),maxMenuHeight:180})),t.createElement("div",{hidden:!o.data||u(S),className:`form-group fade-in-quick${i.touched.storyPoints?i.errors.storyPoints?"error":"success":""}`},t.createElement("label",null,L(S)),t.createElement("input",{type:"number",className:"input",name:S,value:i.values.storyPoints,onChange:e=>i.setFieldValue(S,e.target.value),disabled:!o.data||u(S),"data-test":S})))),t.createElement("div",{className:"absolute-bottom"},!Q&&t.createElement("button",{type:"submit",disabled:T.isFetching,"data-test":"submit",className:`fade-in button button-primary ${T.isFetching?"button-loading":""}`,onClick:()=>i.handleSubmit()},"Save"),Q&&t.createElement("span",null,t.createElement("svg",{className:"checkmark",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 52 52"},t.createElement("circle",{className:"checkmark__circle",cx:"26",cy:"26",r:"25",fill:"none"}),t.createElement("path",{className:"checkmark__check",fill:"none",d:"M14.1 27.2l7.1 7.2 16.7-16.8"}))))))}function Oe(){return l.exports.createElement(ke,{store:Ne},l.exports.createElement(Re,null),l.exports.createElement(ve,{position:"bottom-center"}))}const Pe=document.getElementById("root"),De=Se(Pe);De.render(l.exports.createElement(Oe,null));
