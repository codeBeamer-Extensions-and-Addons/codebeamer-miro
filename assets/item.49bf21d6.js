import"./regular-expressions.a0be6c4f.js";import{a as te,r as n,_ as re,R as e,$ as oe,O as q,T as W,Q as ie,a0 as j,a1 as ee,a2 as ce,a3 as le,a4 as de,a5 as me,a6 as ue,j as fe,a7 as ge,S as V,V as Ee,W as he,X as pe,Y as be,u as Ie,U as ye,A as we,Z as Se}from"./BoardSettingsLoader.5be016a2.js";function ae(s,a="item"){return a.includes("Reference")&&(a=a.split("Reference")[0]),a.includes("Tracker")&&(a=a.split("Tracker")[1]),`/${a.toLowerCase()}/${s}`}function z(s){let a=s.split("/");return a[a.length-1]}function G(s){var a;if(!s.id&&!s.uri)throw new Error("Data must have either id or uri!");return{uri:(a=s.uri)!=null?a:ae(s.id,s.type),name:s.name}}const xe="assignedTo",A="assignedTo",ke="team",D="teams",ve="storyPoints",P="storyPoints",Re="versions",M="versions",Ne="realizedFeature",_="subjects",Fe=[{label:"Assignee",name:A,legacyName:xe,type:"array"},{label:"Team",name:D,legacyName:ke,type:"array"},{label:"Story Points",name:P,legacyName:ve,type:"number"},{label:"Version",name:M,legacyName:Re,type:"array"},{label:"Subject",name:_,legacyName:Ne,type:"array"}];const Ce=/href\=\"\/cb/g,Ae=/src\=\"\/cb/g;function Te(s,a){return a=a.replaceAll(Ce,`href="${s}`),a=a.replaceAll(Ae,`src="${s}`),a=a.replaceAll(/\<a /g,'<a target="_blank" '),a}function Le(s){var y;const{cbAddress:a}=te(E=>E.boardSettings),[l,o]=n.exports.useState((y=s.item.description)!=null?y:""),[i,r]=re();return e.useEffect(()=>{!s.item.id||!s.item.description||i({itemId:s.item.id,markup:s.item.description})},[s.item.description]),e.useEffect(()=>{r.error&&console.warn("Failed to convert wiki description to html"),r.data&&o(a?Te(a,r.data):r.data)},[r]),e.createElement(e.Fragment,null,e.createElement("div",{className:"title sticky"},e.createElement("h3",{className:"h3","data-test":"summary-summary"},s.item.name,s.item.id&&e.createElement("small",{className:"text-italic"}," ","#",s.item.id," "))),l&&e.createElement("p",{"data-test":"summary-description",className:"overflow-ellipsis",dangerouslySetInnerHTML:{__html:l}}))}const se=s=>{const[a,l]=n.exports.useState(),{data:o,error:i,isLoading:r}=oe(s);return e.useEffect(()=>{o&&l(o)},[o]),{relations:a,error:i,isLoading:r}};function De(s){const[a,l]=n.exports.useState(!0),[o,i]=n.exports.useState([]),[r,y]=n.exports.useState(""),[E,R]=n.exports.useState(!1),{relations:h,error:w,isLoading:k}=se(s.itemId),T=n.exports.useRef(null),F=()=>{if(h&&!a){const L=h.downstreamReferences.map(m=>m.itemRevision.id.toString());i(L),y(`item.id IN (${L.join(",")})`)}else console.warn("Can't load Downstream References - data still loading or failed to do so.")};return e.useEffect(()=>{w?l(!0):h&&(h.downstreamReferences.length?l(!1):l(!0))},[h,w]),e.createElement(e.Fragment,null,e.createElement("button",{ref:T,className:`button button-tertiary ${k?"button-loading button-loading-primary":""}`,onClick:F,onMouseEnter:()=>R(!0),onMouseLeave:()=>R(!1),disabled:a,"data-test":"load-downstream-references"},!k&&e.createElement(e.Fragment,null,e.createElement("span",{className:"icon-add-row-bottom"}))),e.createElement(q,{target:T.current,show:E,placement:"bottom"},L=>e.createElement(W,{...L,"data-test":"load-downstream-references-tooltip"},h?`Load Downstream References (${h.downstreamReferences.length})`:"Load the Item's Downstream References onto the board, if they're not yet there")),r&&e.createElement(ie,{items:o,queryString:r}))}async function Me(s,a,l,o,i){for(const r of l){const y=j(r.targetItemId,i);for(const E of y)if(!await ee(s,E,o))return!1}for(const r of a){const y=j(r,i);for(const E of y)if(!await ee(s,E,o))return!1}return!0}async function _e(s,a){a.filter(i=>i.type==="connector").filter(i=>{var r;return((r=i.start)==null?void 0:r.item)===s}).forEach(async i=>{await miro.board.remove(i)})}function Oe(s){const[a,l]=n.exports.useState(!0),[o,i]=n.exports.useState([]),[r,y]=n.exports.useState([]),[E,R]=n.exports.useState(0),[h,w]=n.exports.useState(!0),[k,T]=n.exports.useState(!1),[F,L]=n.exports.useState(!1),{relations:m,error:Z,isLoading:H}=se(s.itemId),N=n.exports.useRef(null);e.useEffect(()=>{async function b(){if(m&&(m.downstreamReferences.length||m.outgoingAssociations.length)){const u=await miro.board.get(),f=await B(u),I=[],p=[];m.downstreamReferences.length&&m.downstreamReferences.forEach(function(O){I.push(O.itemRevision.id)}),m.outgoingAssociations.length&&m.outgoingAssociations.forEach(function(O){const Q={associationId:O.id,targetItemId:O.itemRevision.id};p.push(Q)});const $=await Me(s.cardId.toString(),I,p,u,f);T($);const c=await d(f);l(c==0),y(I),i(p)}}b(),w(!1)},[m]);const B=async b=>{let u=[];return await Promise.all(b.map(async f=>{if(f.type=="app_card"||f.type=="connector"){const I=await f.getMetadata(),p={id:f.id,metadata:I,type:f.type};u.push(p)}})),u},d=async b=>{let u=0;return m&&(await Promise.all(m.outgoingAssociations.map(async function(f){const I=await j(f.itemRevision.id,b);u+=I.length})),await Promise.all(m.downstreamReferences.map(async function(f){const I=await j(f.itemRevision.id,b);u+=I.length})),R(u)),u},U=async()=>{w(!0);const b=await miro.board.get(),u=await B(b);m&&!a?await ce(s.cardId.toString(),r,o,b,u):console.warn("Can't load Associations - data still loading or failed to do so."),T(!k),w(!1)},S=async()=>{w(!0);const b=await miro.board.get();m&&!a?await _e(s.cardId.toString(),b):console.warn("Can't load Associations - data still loading or failed to do so."),T(!k),w(!1)};return e.createElement(e.Fragment,null,e.createElement("button",{ref:N,className:`button button-tertiary ${h?"button-loading button-loading-primary":""}`,onClick:k?()=>S():()=>U(),onMouseEnter:()=>L(!0),onMouseLeave:()=>L(!1),disabled:a,"data-test":"show-dependency"},!h&&e.createElement(e.Fragment,null,e.createElement("span",{className:"icon-arrow-line-shape"}))),e.createElement(q,{target:N.current,show:F,placement:"bottom"},b=>e.createElement(W,{...b,"data-test":"show-dependency-tooltip"},k?`Hide Dependency & Associations (${E})`:`Show Dependency & Associations (${E})`)))}function Pe(s){const[a,l]=n.exports.useState(!1),o=n.exports.useRef(null),i=async()=>{if(!s.cardId){miro.board.notifications.showError("Can't zoom to the Item, since its card Id is unknown");return}let r=await miro.board.getById(s.cardId.toString());r||miro.board.notifications.showError("Can't zoom to the Item, since it doesn't exist on the board"),miro.board.viewport.zoomTo(r)};return e.createElement(e.Fragment,null,s.cardId&&e.createElement(e.Fragment,null,e.createElement("button",{ref:o,className:"button button-tertiary",onClick:i,onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1),"data-test":"zoom-to-item"},e.createElement("span",{className:"icon icon-eye clickable"})),e.createElement(q,{target:o.current,show:a,placement:"bottom"},r=>e.createElement(W,{...r},"Zoom to the Item"))))}function $e(s){return e.createElement("div",null,e.createElement(De,{itemId:s.itemId}),e.createElement(Oe,{itemId:s.itemId,cardId:s.cardId}),e.createElement(Pe,{cardId:s.cardId}))}function Be(s){var O,Q,J,X,K;const[a,l]=n.exports.useState(),[o,i]=n.exports.useState([]),[r,y]=n.exports.useState(),[E,R]=n.exports.useState(!0),[h,w]=n.exports.useState(!1),[k,T]=n.exports.useState(""),[F,L]=n.exports.useState([]),m=Qe(o),{cbAddress:Z}=te(t=>t.boardSettings),[H,N]=le(),[B,d]=de(),[U,S]=me(),[b,u]=ue();e.useEffect(()=>{H(s.itemId)},[]),e.useEffect(()=>{if(d.error){console.error("Fatal error - couldn't load tracker schema: ",d.error),T("Failed loading tracker schema");return}else d.data&&(i(d.data),f(A),R(!1))},[d]),e.useEffect(()=>{N.error?(console.error("Fatal error - couldn't load Item data",N.error),T(`Failed loading Item data from ${Z} for Item with Id ${s.itemId}`)):N.data&&(l(N.data),y(N.data.tracker.id.toString()),(!o||!o.length)&&!d.isFetching&&B(N.data.tracker.id),fe(N.data,s.cardId))},[N]),e.useEffect(()=>{u.error||u.data&&(H(s.itemId),w(!0),setTimeout(()=>{w(!1)},2e3))},[u]);const f=t=>{var x,C;if(F.find(v=>v.key==t)||((x=m.find(v=>v.key==t))==null?void 0:x.value)||!d.data||!r)return;const g=(C=d.data.find(v=>v.trackerItemField==t))==null?void 0:C.id;if(!g){const v=`Can't find field for ${t} in Tracker schema - therefore can't load options.`;console.warn(v),miro.board.notifications.showError(v);return}U({trackerId:r,fieldId:g})};e.useEffect(()=>{S.error&&(console.error(S.error),miro.board.notifications.showError("Failed loading options"))},[S.error]),e.useEffect(()=>{var t,g,x;if(S.data){const C=(t=S.originalArgs)==null?void 0:t.fieldId;if(!C)console.warn("Can't determine which field the received data are options for.");else{const v=(x=(g=d.data)==null?void 0:g.find(Y=>Y.id==C))==null?void 0:x.trackerItemField;if(!v){console.warn("Can't determine which field the received data are options for.");return}const ne=[...F.filter(Y=>Y.key!==v),{key:v,values:S.data}];L(ne)}}},[S.data]);const I=t=>{var x;if(!d.data)return t;let g=(x=d.data.find(C=>C.legacyRestName==t||C.trackerItemField==t))==null?void 0:x.name;return g!=null?g:t},p=t=>{var g,x;return(x=(g=m.find(C=>C.key==t))==null?void 0:g.value)!=null?x:!1},$=t=>{var g;return((g=o.find(x=>x.trackerItemField==t))==null?void 0:g.multipleValues)||!1},c=ge({initialValues:{assignedTo:a!=null&&a.assignedTo?a.assignedTo:[],teams:a!=null&&a.teams?a.teams:[],storyPoints:(O=a==null?void 0:a.storyPoints)!=null?O:-1,versions:a!=null&&a.versions?a.versions:[],subjects:a!=null&&a.subjects?a.subjects:[]},enableReinitialize:!0,validate:t=>({}),onSubmit:t=>{console.log("Submitting");const g={uri:ae(a.id),assignedTo:t.assignedTo.map(G),team:t.teams.map(G),versions:t.versions.map(G),realizedFeature:t.subjects.map(G),storyPoints:t.storyPoints};b(g)}});return e.createElement(e.Fragment,null,k&&e.createElement("div",{className:"centered","data-test":"fatal-error"},e.createElement("h3",{className:"h3"},"Fatal error"),e.createElement("p",null,k)),!k&&E&&e.createElement("div",{className:"centered loading-spinner-lg"}),!k&&!E&&a&&e.createElement("div",{className:"fade-in centered-horizontally h-100 flex-col w-85"},e.createElement("div",{className:"panel-header h-max-25"},e.createElement(Le,{item:a,cardId:s.cardId})),e.createElement("div",{className:"flex-centered mt-4"},e.createElement($e,{itemId:s.itemId,cardId:s.cardId})),e.createElement("hr",null),e.createElement("div",{className:"panel-content mt-1 h-75 overflow-auto"},e.createElement("form",{onSubmit:c.handleSubmit,className:"flex-col position-relative h-100"},e.createElement("h6",{className:"h6 pb-3"},"Editable attributes:"),e.createElement("div",{hidden:!d.data||p(A),className:`form-group fade-in-quick${c.touched.assignedTo?c.errors.assignedTo?"error":"success":""}`,onClick:()=>f(A)},e.createElement("label",{"data-test":A},I(A)),e.createElement(V,{className:"basic-single",classNamePrefix:"select",options:((Q=F.find(t=>t.key==A))==null?void 0:Q.values)||[],value:c.values.assignedTo,getOptionLabel:t=>t.name,getOptionValue:t=>t.id?t.id.toString():t.uri?z(t.uri):"-1",isLoading:S.isFetching,isMulti:$(A),isSearchable:!0,isClearable:!0,isDisabled:!d.data||p(A),onChange:t=>c.setFieldValue(A,t),maxMenuHeight:180})),e.createElement("div",{hidden:!d.data||p(D),className:`form-group fade-in-quick${c.touched.teams?c.errors.teams?"error":"success":""}`,onClick:()=>f(D)},e.createElement("label",{"data-test":D},I(D)),e.createElement(V,{className:"basic-single",classNamePrefix:"select",options:((J=F.find(t=>t.key==D))==null?void 0:J.values)||[],value:c.values.teams,getOptionLabel:t=>t.name,getOptionValue:t=>t.id?t.id.toString():t.uri?z(t.uri):"-1",isLoading:S.isFetching,isMulti:$(D),isSearchable:!0,isClearable:!0,isDisabled:!d.data||p(D),onChange:t=>c.setFieldValue(D,t),maxMenuHeight:180})),e.createElement("div",{hidden:!d.data||p(M),className:`form-group fade-in-quick${c.touched.versions?c.errors.versions?"error":"success":""}`,onClick:()=>f(M)},e.createElement("label",{"data-test":M},I(M)),e.createElement(V,{className:"basic-single",classNamePrefix:"select",options:((X=F.find(t=>t.key==M))==null?void 0:X.values)||[],value:c.values.versions,getOptionLabel:t=>t.name,getOptionValue:t=>t.id?t.id.toString():t.uri?z(t.uri):"-1",isLoading:S.isFetching,isMulti:$(M),isSearchable:!0,isClearable:!0,isDisabled:!d.data||p(M),onChange:t=>c.setFieldValue(M,t),maxMenuHeight:180})),e.createElement("div",{hidden:!d.data||p(_),className:`form-group fade-in-quick${c.touched.subjects?c.errors.subjects?"error":"success":""}`,onClick:()=>f(_)},e.createElement("label",{"data-test":_},I(_)),e.createElement(V,{className:"basic-single",classNamePrefix:"select",options:((K=F.find(t=>t.key==_))==null?void 0:K.values)||[],value:c.values.subjects,getOptionLabel:t=>t.name,getOptionValue:t=>t.id?t.id.toString():t.uri?z(t.uri):"-1",isLoading:S.isFetching,isMulti:$(_),isSearchable:!0,isClearable:!0,isDisabled:!d.data||p(_),onChange:t=>c.setFieldValue(_,t),maxMenuHeight:180,menuPortalTarget:document.body,styles:{menuPortal:t=>({...t,zIndex:9999})}})),e.createElement("div",{hidden:!d.data||p(P),className:`form-group fade-in-quick${c.touched.storyPoints?c.errors.storyPoints?"error":"success":""}`},e.createElement("label",null,I(P)),e.createElement("input",{type:"number",className:"input",name:P,value:c.values.storyPoints,onChange:t=>c.setFieldValue(P,t.target.value),disabled:!d.data||p(P),"data-test":P})),e.createElement("div",{className:"sticky-bottom"},!h&&e.createElement("button",{type:"submit",disabled:u.isFetching,"data-test":"submit",className:`fade-in button button-primary ${u.isFetching?"button-loading":""}`,onClick:()=>c.handleSubmit()},"Save"),h&&e.createElement("span",null,e.createElement("svg",{className:"checkmark",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 52 52"},e.createElement("circle",{className:"checkmark__circle",cx:"26",cy:"26",r:"25",fill:"none"}),e.createElement("path",{className:"checkmark__check",fill:"none",d:"M14.1 27.2l7.1 7.2 16.7-16.8"}))))))))}const Qe=s=>{const[a,l]=n.exports.useState([]);return e.useEffect(()=>{if(!s||!s.length)return;const o=[];for(let i of Fe)o.push({key:i.name,value:!s.some(r=>r.trackerItemField==i.name||r.legacyRestName==i.legacyName)});l(o)},[s]),a};function Ve(s){var E,R,h,w;Ie();const[a]=n.exports.useState((R=(E=s.itemId)!=null?E:new URL(document.location.href).searchParams.get("itemId"))!=null?R:""),[l]=n.exports.useState((w=(h=s.cardId)!=null?h:new URL(document.location.href).searchParams.get("cardId"))!=null?w:""),[o,i]=n.exports.useState(null),[r,y]=ye();return n.exports.useEffect(()=>{if(!a||!l){console.error("Item page called without itemId and/or cardId in query."),i(n.exports.createElement("div",{className:"centered"},n.exports.createElement("p",null,"Something went wrong when opening the card details"),n.exports.createElement("p",null,"Please contact support")));return}},[]),o||(y?n.exports.createElement("div",{className:"centered loading-spinner-lg"}):r?n.exports.createElement(n.exports.Fragment,null,n.exports.createElement(Be,{cardId:l,itemId:a}),n.exports.createElement(Se,{position:"bottom-center"})):n.exports.createElement(we,null))}function ze(){return n.exports.createElement(he,{store:pe},n.exports.createElement(be,{showAuthWhileLoading:!1},n.exports.createElement(Ve,null)))}const Ge=document.getElementById("root"),je=Ee(Ge);je.render(n.exports.createElement(ze,null));
